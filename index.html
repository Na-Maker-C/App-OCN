<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Bases l√©gales</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin:0; background:#f3f4f6; color:#111827; }
    header { background:#111827; color:#fff; padding:1rem 1.5rem; }
    header h1 { margin:0; font-size:1.4rem; }
    main { max-width:960px; margin:1.5rem auto 3rem; padding:0 1rem; }
    .card { background:#fff; border-radius:1rem; padding:1.5rem; box-shadow:0 10px 25px rgba(15,23,42,.08); margin-bottom:1.5rem; }
    .card h2 { margin:0 0 1rem; font-size:1.2rem; }
    label { display:block; font-size:.9rem; font-weight:500; margin-bottom:.25rem; }
    input, select { width:100%; padding:.5rem .6rem; border-radius:.5rem; border:1px solid #d1d5db; font-size:.95rem; box-sizing:border-box; }
    input:focus, select:focus { outline:none; border-color:#4f46e5; box-shadow:0 0 0 1px #4f46e5; }
    .form-row { display:grid; grid-template-columns:1fr; gap:1rem; }
    @media (min-width:640px){ .form-row{ grid-template-columns:1fr 1fr; } }
    button { margin-top:1rem; padding:.6rem 1.2rem; border-radius:999px; border:none; background:#4f46e5; color:#fff; font-size:.95rem; font-weight:600; cursor:pointer; }
    button:hover{ background:#4338ca; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .secondary-btn { background:#e5e7eb; color:#111827; }
    .secondary-btn:hover{ background:#d1d5db; }
    .pill{ display:inline-flex; align-items:center; padding:.15rem .6rem; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:.8rem; margin-right:.4rem; margin-bottom:.3rem; }
    table{ width:100%; border-collapse:collapse; margin-top:1rem; font-size:.9rem; }
    th,td{ padding:.5rem .4rem; border-bottom:1px solid #e5e7eb; vertical-align:top; }
    th{ text-align:left; font-weight:600; font-size:.8rem; text-transform:uppercase; letter-spacing:.03em; color:#6b7280; }
    a{ color:#2563eb; text-decoration:none; word-break:break-all; }
    a:hover{ text-decoration:underline; }
    .muted{ color:#6b7280; font-size:.85rem; }
    code{ background:#f3f4f6; padding:.1rem .25rem; border-radius:.25rem; }

    /* ‚úÖ Conserve les retours √† la ligne d'Excel dans la colonne D√©finition */
    .def-cell { white-space: pre-line; }
  
    /* Layout tweaks */
    #selection-summary { display:flex; flex-wrap:wrap; gap:.4rem; }
    .pill { margin: 0; }

    /* üì± Responsive: table -> "cards" sur mobile */
    @media (max-width: 640px) {
      header { padding: .9rem 1rem; }
      header h1 { font-size: 1.15rem; }

      main { margin: 1rem auto 2rem; padding: 0 .75rem; }
      .card { padding: 1rem; border-radius: .9rem; }

      .filters { grid-template-columns: 1fr; }
      .actions { flex-direction: column; gap: .5rem; }
      .actions button { width: 100%; }

      table { font-size: .95rem; }
      thead { display: none; }

      table, tbody, tr, td { display: block; width: 100%; }
      tr {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: .9rem;
        padding: .75rem .85rem;
        margin-top: .75rem;
      }

      td {
        border: 0;
        padding: .4rem 0;
      }

      td::before {
        content: attr(data-label);
        display: block;
        font-weight: 700;
        font-size: .75rem;
        letter-spacing: .03em;
        text-transform: uppercase;
        color: #6b7280;
        margin-bottom: .2rem;
      }

      /* D√©finition un peu plus mise en avant */
      td.def-cell strong { font-size: 1rem; display: inline-block; }

      a { word-break: break-word; }
    }

  </style>
</head>
<body>
<header><h1>Bases l√©gales</h1></header>

<main>
  <section id="step1" class="card">
    <h2>1. Param√®tres du v√©hicule</h2>
    <p class="muted">Les cat√©gories sont charg√©es automatiquement depuis <code>regulations_v2.json</code>.</p>

    <form id="entry-form">
      <div class="form-row">
        <div>
          <label for="firstRegDate">Date 1<sup>√®re</sup> mise en circulation</label>
          <input type="date" id="firstRegDate" required />
        </div>
        <div>
          <label for="category">Cat√©gorie</label>
          <select id="category" required>
            <option value="">Chargement‚Ä¶</option>
          </select>
        </div>
      </div>

      <button id="open-btn" type="submit" disabled>Ouvrir la fiche</button>
      <p id="load-status" class="muted" style="margin-top:.75rem;"></p>
    </form>
  </section>

  <section id="step2" class="card" style="display:none;">
    <h2>2. Fiche r√©glementaire</h2>
    <p class="muted" id="selection-summary"></p>
    <div id="regulations-container"></div>
    <button type="button" class="secondary-btn" id="back-btn">‚Üê Retour</button>
  </section>
</main>

<script>
  let allSheets = {};
  const categorySelect = document.getElementById("category");
  const openBtn = document.getElementById("open-btn");
  const loadStatus = document.getElementById("load-status");

  function setStatus(msg){ loadStatus.textContent = msg || ""; }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  async function loadAllSheetsAndCategories(){
    openBtn.disabled = true;

    // Si ouvert en double-clic (file://), fetch est souvent bloqu√©
    if (location.protocol === "file:") {
      categorySelect.innerHTML = `<option value="">Erreur de chargement</option>`;
      setStatus("Ouvre via GitHub Pages OU en local: python -m http.server 8000 puis http://localhost:8000/");
      return;
    }

    setStatus("Chargement des cat√©gories‚Ä¶");
    try {
      const url = `./regulations_v2.json?v=${Date.now()}`; // anti-cache
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`regulations_v2.json introuvable (HTTP ${res.status})`);

      allSheets = await res.json();
      const keys = Object.keys(allSheets || {}).sort((a,b) => a.localeCompare(b, "fr"));

      categorySelect.innerHTML = `<option value="">-- Choisir --</option>`;
      if (keys.length === 0) {
        categorySelect.innerHTML = `<option value="">Aucune cat√©gorie</option>`;
        setStatus("Le fichier regulations_v2.json est vide.");
        return;
      }

      for (const key of keys) {
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = key;
        categorySelect.appendChild(opt);
      }

      openBtn.disabled = false;
      setStatus(`OK : ${keys.length} cat√©gorie(s) charg√©e(s).`);
    } catch (err) {
      categorySelect.innerHTML = `<option value="">Erreur de chargement</option>`;
      setStatus("Erreur : " + err.message + " ‚Äî V√©rifie que index.html et regulations_v2.json sont au m√™me endroit.");
    }
  }

  function renderRegulations(data){
    const container = document.getElementById("regulations-container");
    if (!Array.isArray(data) || data.length === 0) {
      container.innerHTML = "<p class='muted'>Aucune donn√©e pour cette cat√©gorie.</p>";
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>D√©finition</th>
            <th>CH</th>
            <th>EU</th>
            <th>Autres directives</th>
          </tr>
        </thead>
        <tbody>
    `;

    for (const row of data) {
      const def = escapeHtml(row["D√©f."] || "");

      let colCH = escapeHtml(row["CH"] || "‚Äì");
      if (row["Article"] && row["Link"] && String(row["Article"]).toLowerCase() !== "none") {
        colCH += `<br><a href="${escapeHtml(row["Link"])}" target="_blank" rel="noopener noreferrer">${escapeHtml(row["Article"])}</a>`;
      }

      let colEU = escapeHtml(row["EU"] || "‚Äì");
      if (row["N¬∞"]) {
        if (row["Link.1"]) {
          colEU += `<br><a href="${escapeHtml(row["Link.1"])}" target="_blank" rel="noopener noreferrer">${escapeHtml(row["N¬∞"])}</a>`;
        } else {
          colEU += `<br>${escapeHtml(row["N¬∞"])}`;
        }
      }

      let colAutres = "‚Äì";
      if (row["Directives, autres"]) {
        colAutres = escapeHtml(row["Directives, autres"]);
        if (row["N¬∞.1"]) {
          if (row["Link.2"]) {
            colAutres += `<br><a href="${escapeHtml(row["Link.2"])}" target="_blank" rel="noopener noreferrer">${escapeHtml(row["N¬∞.1"])}</a>`;
          } else {
            colAutres += `<br>${escapeHtml(row["N¬∞.1"])}`;
          }
        }
      }

      html += `
        <tr>
          <td class="def-cell" data-label="D√©finition"><strong>${def}</strong></td>
          <td data-label="CH">${colCH}</td>
          <td data-label="EU">${colEU}</td>
          <td data-label="Autres directives">${colAutres}</td>
        </tr>
      `;
    }

    html += "</tbody></table>";
    container.innerHTML = html;
  }

  const form = document.getElementById("entry-form");
  const step1 = document.getElementById("step1");
  const step2 = document.getElementById("step2");
  const selectionSummary = document.getElementById("selection-summary");
  const backBtn = document.getElementById("back-btn");

  form.addEventListener("submit", function (e) {
    e.preventDefault();
    const date = document.getElementById("firstRegDate").value;
    const category = categorySelect.value;

    selectionSummary.innerHTML = `
      <span class="pill">Date 1<sup>√®re</sup> mise en circ. : ${escapeHtml(date || "-")}</span>
      <span class="pill">Cat√©gorie : ${escapeHtml(category || "-")}</span>
    `;

    step1.style.display = "none";
    step2.style.display = "block";

    const sheetData = allSheets[category] || [];
    renderRegulations(sheetData);
  });

  backBtn.addEventListener("click", () => {
    step2.style.display = "none";
    step1.style.display = "block";
  });

  loadAllSheetsAndCategories();
</script>
</body>
</html>
